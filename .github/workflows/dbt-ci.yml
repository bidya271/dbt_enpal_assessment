name: dbt CI

on:
  pull_request:
    branches: [ '**' ]
  push:
    branches: [ main ]

jobs:
  dbt-pr:
    name: "PR: compile + test (fast)"
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: admin
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U admin -d postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for Postgres (hosted service)
        run: |
          echo "Waiting for Postgres to be ready..."
          until pg_isready -h localhost -p 5432 -U admin; do
            sleep 2
          done
        env:
          PGPASSWORD: admin

      - name: Init raw tables (public) + load CSVs
        env:
          PGPASSWORD: admin
        run: |
          # Create tables
          psql -h localhost -p 5432 -U admin -d postgres -f init.sql

          # Load data into public schema
          psql -h localhost -p 5432 -U admin -d postgres -c "\copy public.activity FROM 'seeds/activity.csv' CSV HEADER"
          psql -h localhost -p 5432 -U admin -d postgres -c "\copy public.activity_types FROM 'seeds/activity_types.csv' CSV HEADER"
          psql -h localhost -p 5432 -U admin -d postgres -c "\copy public.deal_changes FROM 'seeds/deal_changes.csv' CSV HEADER"
          psql -h localhost -p 5432 -U admin -d postgres -c "\copy public.fields FROM 'seeds/fields.csv' CSV HEADER"
          psql -h localhost -p 5432 -U admin -d postgres -c "\copy public.stages FROM 'seeds/stages.csv' CSV HEADER"
          psql -h localhost -p 5432 -U admin -d postgres -c "\copy public.users FROM 'seeds/users.csv' CSV HEADER"

      - name: Install dbt and adapter
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==1.8.0 dbt-postgres==1.8.0 psycopg2-binary
          
      - name: Write profiles.yml
        run: |
          echo "enpal_assessment_project:" > profiles.yml
          echo "  target: dev" >> profiles.yml
          echo "  outputs:" >> profiles.yml
          echo "    dev:" >> profiles.yml
          echo "      type: postgres" >> profiles.yml
          echo "      host: localhost" >> profiles.yml
          echo "      user: admin" >> profiles.yml
          echo "      port: 5432" >> profiles.yml
          echo "      password: admin" >> profiles.yml
          echo "      dbname: postgres" >> profiles.yml
          echo "      schema: pipedrive_analytics" >> profiles.yml
          echo "      threads: 1" >> profiles.yml

      - name: dbt deps
        run: dbt deps --profiles-dir .

      - name: dbt seed (Load Seeds if any)
        run: dbt seed --profiles-dir .

      - name: dbt run (Build Tables)
        run: dbt run --profiles-dir .

      - name: dbt test hiding
        run: dbt test --profiles-dir .

  dbt-main:
    name: "main branch: full run"
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: admin
          POSTGRES_PASSWORD: admin
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U admin -d postgres"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for Postgres
        run: |
          echo "Waiting for Postgres to be ready..."
          until pg_isready -h localhost -p 5432 -U admin; do
            sleep 2
          done
        env:
          PGPASSWORD: admin

      - name: Init raw tables (public) + load CSVs
        env:
          PGPASSWORD: admin
        run: |
          # Create tables
          psql -h localhost -p 5432 -U admin -d postgres -f init.sql

          # Load data into public schema
          psql -h localhost -p 5432 -U admin -d postgres -c "\copy public.activity FROM 'seeds/activity.csv' CSV HEADER"
          psql -h localhost -p 5432 -U admin -d postgres -c "\copy public.activity_types FROM 'seeds/activity_types.csv' CSV HEADER"
          psql -h localhost -p 5432 -U admin -d postgres -c "\copy public.deal_changes FROM 'seeds/deal_changes.csv' CSV HEADER"
          psql -h localhost -p 5432 -U admin -d postgres -c "\copy public.fields FROM 'seeds/fields.csv' CSV HEADER"
          psql -h localhost -p 5432 -U admin -d postgres -c "\copy public.stages FROM 'seeds/stages.csv' CSV HEADER"
          psql -h localhost -p 5432 -U admin -d postgres -c "\copy public.users FROM 'seeds/users.csv' CSV HEADER"

      - name: Install dbt and adapter
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core==1.8.0 dbt-postgres==1.8.0 psycopg2-binary
          
      - name: Write profiles.yml
        run: |
          echo "enpal_assessment_project:" > profiles.yml
          echo "  target: dev" >> profiles.yml
          echo "  outputs:" >> profiles.yml
          echo "    dev:" >> profiles.yml
          echo "      type: postgres" >> profiles.yml
          echo "      host: localhost" >> profiles.yml
          echo "      user: admin" >> profiles.yml
          echo "      port: 5432" >> profiles.yml
          echo "      password: admin" >> profiles.yml
          echo "      dbname: postgres" >> profiles.yml
          echo "      schema: pipedrive_analytics" >> profiles.yml
          echo "      threads: 1" >> profiles.yml

      - name: dbt deps
        run: dbt deps --profiles-dir .

      - name: dbt seed
        run: dbt seed --profiles-dir .

      - name: Full dbt run
        run: dbt run --profiles-dir .

      - name: dbt test
        run: dbt test --profiles-dir .
